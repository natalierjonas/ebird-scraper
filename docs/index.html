<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eBird Notable Observations - L197353</title>

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px 40px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card .number {
            font-size: 2.5em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 0.9em;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .content {
            padding: 40px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            padding: 15px 30px;
            background: transparent;
            border: none;
            font-size: 1em;
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        table.dataTable {
            width: 100% !important;
            border-collapse: collapse;
        }

        table.dataTable thead th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        table.dataTable tbody td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        table.dataTable tbody tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #6c757d;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge.verified {
            background: #d4edda;
            color: #155724;
        }

        .badge.unverified {
            background: #fff3cd;
            color: #856404;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-size: 0.9em;
            border-top: 2px solid #e9ecef;
        }

        footer a {
            color: #667eea;
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>eBird Notable Observations</h1>
            <p>Hotspot L197353 - Rare and Notable Bird Sightings</p>
        </header>

        <div class="stats">
            <div class="stat-card">
                <div class="number" id="total-observations">-</div>
                <div class="label">Total Observations</div>
            </div>
            <div class="stat-card">
                <div class="number" id="unique-species">-</div>
                <div class="label">Unique Species</div>
            </div>
            <div class="stat-card">
                <div class="number" id="last-updated">-</div>
                <div class="label">Last Updated</div>
            </div>
            <div class="stat-card">
                <div class="number" id="total-scrapes">-</div>
                <div class="label">Total Scrapes</div>
            </div>
        </div>

        <div class="content">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('latest')">Latest Observations</button>
                <button class="tab" onclick="switchTab('historical')">Historical Data</button>
            </div>

            <div id="latest-tab" class="tab-content active">
                <div class="table-wrapper">
                    <table id="latest-table" class="display responsive nowrap" style="width:100%">
                        <thead>
                            <tr>
                                <th>Species</th>
                                <th>Scientific Name</th>
                                <th>Date</th>
                                <th>Location</th>
                                <th>Observer</th>
                                <th>Count</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="historical-tab" class="tab-content">
                <div class="table-wrapper">
                    <table id="historical-table" class="display responsive nowrap" style="width:100%">
                        <thead>
                            <tr>
                                <th>Scrape Date</th>
                                <th>Species</th>
                                <th>Scientific Name</th>
                                <th>Observation Date</th>
                                <th>Location</th>
                                <th>Observer</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <footer>
            <p>Data sourced from <a href="https://ebird.org" target="_blank">eBird</a> via their public API</p>
            <p>Updates automatically every 6 hours</p>
        </footer>
    </div>

    <!-- jQuery and DataTables JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

    <script>
        let latestData = null;
        let historicalData = null;
        let latestTable = null;
        let historicalTable = null;

        // Switch between tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Format relative time
        function timeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        // Load and display data
        async function loadData() {
            try {
                // Fetch both latest and historical data
                const [latestResponse, historicalResponse] = await Promise.all([
                    fetch('./data/latest.json'),
                    fetch('./data/historical.json')
                ]);

                if (!latestResponse.ok) throw new Error('Failed to load latest data');

                latestData = await latestResponse.json();
                historicalData = historicalResponse.ok ? await historicalResponse.json() : [];

                updateStats();
                populateLatestTable();
                populateHistoricalTable();

            } catch (error) {
                console.error('Error loading data:', error);
                document.querySelector('.content').innerHTML = `
                    <div class="error">
                        <strong>Error loading data:</strong> ${error.message}
                        <br><br>
                        This might be because the scraper hasn't run yet. Please check back later.
                    </div>
                `;
            }
        }

        // Update statistics
        function updateStats() {
            const uniqueSpecies = new Set(latestData.observations.map(obs => obs.species_code)).size;

            document.getElementById('total-observations').textContent = latestData.observation_count;
            document.getElementById('unique-species').textContent = uniqueSpecies;
            document.getElementById('last-updated').textContent = timeAgo(latestData.timestamp);
            document.getElementById('total-scrapes').textContent = historicalData.length;
        }

        // Populate latest observations table
        function populateLatestTable() {
            const tableData = latestData.observations.map(obs => [
                obs.species_common_name,
                obs.species_scientific_name,
                formatDate(obs.observation_date),
                obs.location_name,
                obs.observer_id,
                obs.how_many || 'Unknown',
                obs.observation_reviewed
                    ? '<span class="badge verified">Verified</span>'
                    : '<span class="badge unverified">Unverified</span>'
            ]);

            if (latestTable) {
                latestTable.destroy();
            }

            latestTable = $('#latest-table').DataTable({
                data: tableData,
                responsive: true,
                order: [[2, 'desc']], // Sort by date descending
                pageLength: 25,
                language: {
                    search: "Search observations:",
                    lengthMenu: "Show _MENU_ observations per page",
                    info: "Showing _START_ to _END_ of _TOTAL_ observations",
                    emptyTable: "No observations found"
                }
            });
        }

        // Populate historical data table
        function populateHistoricalTable() {
            const tableData = [];

            historicalData.forEach(scrape => {
                scrape.observations.forEach(obs => {
                    tableData.push([
                        formatDate(scrape.timestamp),
                        obs.species_common_name,
                        obs.species_scientific_name,
                        formatDate(obs.observation_date),
                        obs.location_name,
                        obs.observer_id,
                        obs.how_many || 'Unknown'
                    ]);
                });
            });

            if (historicalTable) {
                historicalTable.destroy();
            }

            historicalTable = $('#historical-table').DataTable({
                data: tableData,
                responsive: true,
                order: [[0, 'desc']], // Sort by scrape date descending
                pageLength: 25,
                language: {
                    search: "Search historical data:",
                    lengthMenu: "Show _MENU_ entries per page",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    emptyTable: "No historical data available yet"
                }
            });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
